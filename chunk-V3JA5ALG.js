import{a as $e}from"./chunk-UWHKPDZO.js";import{a as Oe,b as Pe}from"./chunk-JFFEMBUM.js";import{c as ne}from"./chunk-NAZHZL2Z.js";import{a as Te}from"./chunk-MNEFO67F.js";import{a as C,b as ye,d as Se,e as we,f as G,g as Ce,h as H,k as Ee,l as De,m as Fe}from"./chunk-37E4UQA3.js";import{b as oe,c as S,d as ae,e as de,g as le,h as se,i as ce,j as pe,k as ue,l as me,m as he,n as ge,o as fe,p as be,r as xe,s as ve,t as _e}from"./chunk-JJK6J4PC.js";import"./chunk-ERIR3R6Y.js";import{A as Q,Ia as d,Ib as o,Jb as O,Kb as y,O as q,Qb as R,Sa as I,Vb as w,Wa as J,Wb as N,Xb as A,_a as F,a as L,aa as W,b as V,db as K,ea as Y,jb as m,k as $,ka as E,kb as i,la as D,lb as t,ma as j,mb as T,na as z,sc as X,tb as k,tc as Z,ub as h,uc as ee,wb as g,wc as te,xc as ie,yc as re,z as U}from"./chunk-JV3ZGQQZ.js";var Me=(()=>{let u=class u{constructor(e){this.firestore=e}getPurchaseOrders(){let e=G(this.firestore,"purchaseOrders"),n=De(e,Ee("date","desc"));return Se(n,{idField:"id"})}addPurchaseOrder(e){let n=G(this.firestore,"purchaseOrders");return we(n,V(L({},e),{createdAt:C.now()})).then(()=>{})}updatePurchaseOrder(e,n){let r=H(this.firestore,"purchaseOrders",e);return Fe(r,n)}deletePurchaseOrder(e){let n=H(this.firestore,"purchaseOrders",e);return Ce(n)}generateOrderNumber(){let e=new Date,n=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0"),p=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`CMD-${n}${r}${l}-${p}`}};u.\u0275fac=function(n){return new(n||u)(Y(ye))},u.\u0275prov=W({token:u,factory:u.\u0275fac,providedIn:"root"});let s=u;return s})();var Ae=()=>[];function Ve(s,u){if(s&1){let a=k();i(0,"div",34)(1,"strong"),o(2,"Erreur :"),t(),o(3),i(4,"button",35),h("click",function(){E(a);let n=g();return D(n.errorMessage="")}),o(5,"\xD7"),t()()}if(s&2){let a=g();d(3),y(" ",a.errorMessage," ")}}function Be(s,u){s&1&&(i(0,"span"),o(1,"+ Nouvelle Commande"),t())}function qe(s,u){s&1&&(i(0,"span"),o(1,"Fermer"),t())}function je(s,u){if(s&1&&(i(0,"option",69),o(1),t()),s&2){let a=u.$implicit;m("value",a.id),d(),O(a.name)}}function ze(s,u){if(s&1){let a=k();i(0,"div",56)(1,"div",57)(2,"label",58),o(3,"Produit *"),t(),i(4,"select",59),h("change",function(n){let r=E(a).index,l=g(2);return D(l.onProductSelected(n,r))}),i(5,"option",60),o(6,"-- S\xE9lectionnez --"),t(),F(7,je,2,2,"option",61),w(8,"async"),t()(),i(9,"div",62)(10,"label",58),o(11,"Quantit\xE9 *"),t(),T(12,"input",63),t(),i(13,"div",62)(14,"label",58),o(15,"Prix Unit. (DT) *"),t(),T(16,"input",64),t(),i(17,"div",62)(18,"label",58),o(19,"Sous-total"),t(),T(20,"input",65),w(21,"number"),t(),i(22,"div",66)(23,"button",67),h("click",function(){E(a);let n=g(2);return D(n.addProductLine())}),o(24,"+"),t(),i(25,"button",68),h("click",function(){let n=E(a).index,r=g(2);return D(r.removeProductLine(n))}),o(26,"-"),t()()()}if(s&2){let a=u.index,e=g(2);m("formGroupName",a),d(7),m("ngForOf",N(8,4,e.products$)),d(13),m("value",A(21,6,e.calculateSubtotal(a),"1.2-2")),d(5),m("disabled",e.productsFormArray.length===1)}}function Re(s,u){s&1&&(i(0,"span"),o(1,"Enregistrement..."),t())}function Ge(s,u){if(s&1&&(i(0,"span"),o(1),t()),s&2){let a=g(2);d(),O(a.isEditing?"Mettre \xE0 jour":"Cr\xE9er Commande")}}function He(s,u){if(s&1){let a=k();i(0,"div",36)(1,"h2",37),o(2),t(),i(3,"form",38),h("ngSubmit",function(){E(a);let n=g();return D(n.onSubmit())}),i(4,"div",15)(5,"div")(6,"label",39),o(7,"N\xB0 Commande *"),t(),T(8,"input",40),t(),i(9,"div")(10,"label",39),o(11,"Date *"),t(),T(12,"input",41),t(),i(13,"div")(14,"label",39),o(15,"Fournisseur *"),t(),T(16,"ng-select",42),w(17,"async"),t(),i(18,"div")(19,"label",39),o(20,"Livraison Pr\xE9vue"),t(),T(21,"input",43),t()(),i(22,"div",44)(23,"h3",45),o(24,"Produits"),t(),i(25,"div",46),F(26,ze,27,9,"div",47),t(),i(27,"div",48)(28,"div",49)(29,"span"),o(30,"Total :"),t(),i(31,"span",50),o(32),w(33,"number"),t()()()(),i(34,"div")(35,"label",39),o(36,"Statut"),t(),i(37,"select",51)(38,"option",20),o(39,"En Attente"),t(),i(40,"option",21),o(41,"Confirm\xE9e"),t(),i(42,"option",22),o(43,"Livr\xE9e"),t(),i(44,"option",23),o(45,"Annul\xE9e"),t()()(),i(46,"div")(47,"label",39),o(48,"Notes"),t(),T(49,"textarea",52),t(),i(50,"div",53)(51,"button",54),F(52,Re,2,0,"span",10)(53,Ge,2,1,"span",10),t(),i(54,"button",55),h("click",function(){E(a);let n=g();return D(n.resetForm())}),o(55,"Annuler"),t()()()()}if(s&2){let a=g();d(2),y("",a.isEditing?"Modifier":"Nouvelle"," Commande"),d(),m("formGroup",a.orderForm),d(13),m("items",N(17,10,a.suppliers$)??R(15,Ae))("searchable",!0)("clearable",!0),d(10),m("ngForOf",a.productsFormArray.controls),d(6),y("",A(33,12,a.calculateTotal(),"1.2-2")," DT"),d(19),m("disabled",a.isLoading||a.orderForm.invalid),d(),m("ngIf",a.isLoading),d(),m("ngIf",!a.isLoading)}}function Ue(s,u){if(s&1&&(i(0,"tr",91)(1,"td",92),o(2),t(),i(3,"td",93),o(4),t(),i(5,"td",92),o(6),t(),i(7,"td",92),o(8),w(9,"number"),t(),i(10,"td",94),o(11),w(12,"number"),t()()),s&2){let a=u.$implicit;d(2),O(a.productName),d(2),O(a.description),d(2),O(a.quantity),d(2),y("",A(9,5,a.unitPrice,"1.2-2")," DT"),d(3),y("",A(12,8,a.subtotal,"1.2-2")," DT")}}function Qe(s,u){if(s&1){let a=k();i(0,"div",79)(1,"table",80)(2,"thead",81)(3,"tr")(4,"th",82),o(5,"Produit"),t(),i(6,"th",82),o(7,"Description"),t(),i(8,"th",82),o(9,"Quantit\xE9"),t(),i(10,"th",82),o(11,"Prix Unit."),t(),i(12,"th",82),o(13,"Sous-total"),t()()(),i(14,"tbody"),F(15,Ue,13,11,"tr",83),i(16,"tr",84)(17,"td",85),o(18,"Total :"),t(),i(19,"td",86),o(20),w(21,"number"),t()()()(),i(22,"div",87)(23,"button",88),h("click",function(){E(a);let n=g().$implicit,r=g(2);return D(r.editOrder(n))}),o(24,"Modifier"),t(),i(25,"button",89),h("click",function(){E(a);let n=g().$implicit,r=g(2);return D(r.deleteOrder(n.id,n.orderNumber))}),o(26,"Supprimer"),t(),i(27,"button",90),h("click",function(){E(a);let n=g().$implicit,r=g(2);return D(r.printItem(n))}),o(28,"Imprimer Commande"),t()()()}if(s&2){let a=g().$implicit;d(15),m("ngForOf",a==null?null:a.products),d(5),y("",A(21,2,a.totalAmount,"1.2-2")," DT")}}function We(s,u){if(s&1){let a=k();i(0,"div",73)(1,"div",74),h("click",function(){let n=E(a).$implicit,r=g(2);return D(r.toggleExpand(n.id))}),i(2,"div",75)(3,"div")(4,"strong"),o(5,"N\xB0 :"),t(),o(6),t(),i(7,"div")(8,"strong"),o(9,"Date:"),t(),o(10),t(),i(11,"div")(12,"strong"),o(13,"Fournisseur:"),t(),o(14),t(),i(15,"div")(16,"span",76),o(17),t()(),i(18,"div")(19,"strong"),o(20,"Total:"),t(),o(21),w(22,"number"),t()(),i(23,"button",77),o(24),t()(),F(25,Qe,29,5,"div",78),t()}if(s&2){let a=u.$implicit,e=g(2);K("data-id",a.id),d(6),y(" ",a.orderNumber),d(4),y(" ",e.formatDate(a.date)),d(4),y(" ",a.supplier),d(2),m("ngClass",e.getStatusClass(a.status||"pending")),d(),O(e.getStatusLabel(a.status||"pending")),d(4),y(" ",A(22,9,a.totalAmount,"1.2-2")," DT"),d(3),O(e.expandedOrderId===a.id?"\u25BC":"\u25BA"),d(),m("ngIf",e.expandedOrderId===a.id)}}function Ye(s,u){s&1&&(i(0,"div",95),o(1," Aucune commande trouv\xE9e. "),t())}function Je(s,u){if(s&1&&(i(0,"div",70),F(1,We,26,12,"div",71),w(2,"async"),F(3,Ye,2,0,"div",72),w(4,"async"),t()),s&2){let a,e=g();d(),m("ngForOf",N(2,2,e.filteredOrders$)),d(2),m("ngIf",((a=N(4,4,e.filteredOrders$))==null?null:a.length)===0)}}var mt=(()=>{let u=class u{constructor(e,n,r,l,p){this.ordersService=e,this.productsService=n,this.suppliersService=r,this.fb=l,this.router=p,this.productList=[],this.isLoading=!1,this.isEditing=!1,this.editingId=null,this.errorMessage="",this.showForm=!1,this.expandedOrderId=null,this.searchTerm="",this.searchTerm$=new $(""),this.selectedSupplier=null,this.selectedSupplier$=new $(null),this.dateFrom=null,this.dateFrom$=new $(null),this.dateTo=null,this.dateTo$=new $(null),this.minAmount=null,this.minAmount$=new $(null),this.maxAmount=null,this.maxAmount$=new $(null),this.statusFilter="all",this.statusFilter$=new $("all"),this.sortBy="date",this.sortBy$=new $("date"),this.sortOrder="desc",this.sortOrder$=new $("desc");let v=new Date().toISOString().split("T")[0];this.orderForm=this.fb.group({orderNumber:[this.ordersService.generateOrderNumber(),S.required],date:[v,S.required],supplier:["",S.required],expectedDeliveryDate:[""],products:this.fb.array([this.createProductLine()]),notes:[""],status:["pending"]})}ngOnInit(){this.loadOrders(),this.products$=this.productsService.getProducts(),this.products$.subscribe(e=>{this.productList=e}),this.suppliers$=this.suppliersService.getSuppliers(),this.filteredOrders$=Q([this.orders$,this.searchTerm$,this.selectedSupplier$,this.dateFrom$,this.dateTo$,this.minAmount$,this.maxAmount$,this.statusFilter$,this.sortBy$,this.sortOrder$]).pipe(U(([e,n,r,l,p,v,x,_,P,B])=>{let f=e;if(n&&(f=f.filter(c=>c.orderNumber.toLowerCase().includes(n.toLowerCase()))),r&&(f=f.filter(c=>c.supplier===r)),l){let c=new Date(l);f=f.filter(b=>(b.date instanceof C?b.date.toDate():new Date(b.date))>=c)}if(p){let c=new Date(p);c.setHours(23,59,59),f=f.filter(b=>(b.date instanceof C?b.date.toDate():new Date(b.date))<=c)}return v!==null&&(f=f.filter(c=>(c.totalAmount||0)>=v)),x!==null&&(f=f.filter(c=>(c.totalAmount||0)<=x)),_!=="all"&&(f=f.filter(c=>(c.status||"pending")===_)),f=f.sort((c,b)=>{let M=0;if(P==="date"){let Ie=c.date instanceof C?c.date.toDate().getTime():new Date(c.date).getTime(),ke=b.date instanceof C?b.date.toDate().getTime():new Date(b.date).getTime();M=Ie-ke}else P==="supplier"?M=c.supplier.localeCompare(b.supplier):P==="amount"&&(M=(c.totalAmount||0)-(b.totalAmount||0));return B==="asc"?M:-M}),f}))}get productsFormArray(){return this.orderForm.get("products")}createProductLine(){return this.fb.group({productId:["",S.required],quantity:[1,[S.required,S.min(1)]],unitPrice:[0,[S.required,S.min(.01)]]})}addProductLine(){this.productsFormArray.push(this.createProductLine())}removeProductLine(e){this.productsFormArray.length>1&&this.productsFormArray.removeAt(e)}onProductSelected(e,n){let l=e.target.value,p=this.productsFormArray.at(n);if(!l||!p){p?.patchValue({unitPrice:0});return}let v=this.productList.find(x=>x.id===l);v?p.patchValue({unitPrice:v.price}):(p.patchValue({unitPrice:0}),console.warn(`Produit non trouv\xE9 dans productList: ${l}`))}calculateSubtotal(e){let n=this.productsFormArray.at(e)?.value;return(n?.quantity||0)*(n?.unitPrice||0)}calculateTotal(){return this.productsFormArray.controls.reduce((e,n)=>{let r=n.value;return e+(r.quantity||0)*(r.unitPrice||0)},0)}loadOrders(){this.orders$=this.ordersService.getPurchaseOrders()}onSearchChange(e){this.searchTerm=e,this.searchTerm$.next(e)}onSupplierFilterChange(e){this.selectedSupplier=e,this.selectedSupplier$.next(e)}onDateFromChange(e){this.dateFrom=e,this.dateFrom$.next(e)}onDateToChange(e){this.dateTo=e,this.dateTo$.next(e)}onMinAmountChange(e){this.minAmount=e,this.minAmount$.next(e)}onMaxAmountChange(e){this.maxAmount=e,this.maxAmount$.next(e)}onStatusFilterChange(e){this.statusFilter=e,this.statusFilter$.next(e)}onSortChange(e){this.sortBy===e?this.sortOrder=this.sortOrder==="asc"?"desc":"asc":(this.sortBy=e,this.sortOrder=this.sortBy==="date"?"desc":"asc"),this.sortBy$.next(this.sortBy),this.sortOrder$.next(this.sortOrder)}clearFilters(){this.searchTerm="",this.searchTerm$.next(""),this.selectedSupplier=null,this.selectedSupplier$.next(null),this.dateFrom=null,this.dateFrom$.next(null),this.dateTo=null,this.dateTo$.next(null),this.minAmount=null,this.minAmount$.next(null),this.maxAmount=null,this.maxAmount$.next(null),this.statusFilter="all",this.statusFilter$.next("all"),this.sortBy="date",this.sortBy$.next("date"),this.sortOrder="desc",this.sortOrder$.next("desc")}onSubmit(){if(this.orderForm.invalid){this.errorMessage="Veuillez remplir tous les champs obligatoires.";return}this.isLoading=!0,this.errorMessage="";let e=this.orderForm.value,n=e.products.map(l=>{let p=this.productList.find(P=>P.id===l.productId),v=p?p.name:"Produit_Inconnu",x=p&&p.description||"Pas_de_description",_=(l.quantity||0)*(l.unitPrice||0);return V(L({},l),{productName:v,description:x,subtotal:_})}),r={orderNumber:e.orderNumber,date:C.fromDate(new Date(e.date)),supplier:e.supplier,products:n,totalAmount:this.calculateTotal(),notes:e.notes,status:e.status||"pending"};if(e.expectedDeliveryDate)try{r.expectedDeliveryDate=C.fromDate(new Date(e.expectedDeliveryDate))}catch{console.warn("Invalid date format for expectedDeliveryDate:",e.expectedDeliveryDate)}this.isEditing&&this.editingId?this.ordersService.updatePurchaseOrder(this.editingId,r).then(()=>{this.resetForm(),this.loadOrders()}).catch(l=>{this.errorMessage="Erreur lors de la modification.",console.error(l)}).finally(()=>this.isLoading=!1):this.ordersService.addPurchaseOrder(r).then(()=>{this.resetForm(),this.loadOrders()}).catch(l=>{this.errorMessage="Erreur lors de l'ajout.",console.error(l)}).finally(()=>this.isLoading=!1)}editOrder(e){this.isEditing=!0,this.editingId=e.id||null;let n=e.date instanceof C?e.date.toDate().toISOString().split("T")[0]:"",r=e.expectedDeliveryDate instanceof C?e.expectedDeliveryDate.toDate().toISOString().split("T")[0]:"";this.productsFormArray.clear(),e.products.forEach(l=>{this.productsFormArray.push(this.fb.group({productId:[l.productId,S.required],quantity:[l.quantity,[S.required,S.min(1)]],unitPrice:[l.unitPrice,[S.required,S.min(.01)]]}))}),this.orderForm.patchValue({orderNumber:e.orderNumber,date:n,supplier:e.supplier,expectedDeliveryDate:r,notes:e.notes,status:e.status||"pending"}),this.showForm=!0,window.scrollTo({top:0,behavior:"smooth"})}deleteOrder(e,n){confirm(`Supprimer la commande "${n}" ?`)&&(this.isLoading=!0,this.ordersService.deletePurchaseOrder(e).then(()=>{this.loadOrders()}).catch(r=>{this.errorMessage="Erreur lors de la suppression.",console.error(r)}).finally(()=>this.isLoading=!1))}resetForm(){this.productsFormArray.clear(),this.productsFormArray.push(this.createProductLine());let e=new Date().toISOString().split("T")[0];this.orderForm.patchValue({orderNumber:this.ordersService.generateOrderNumber(),date:e,supplier:"",expectedDeliveryDate:"",notes:"",status:"pending"}),this.isEditing=!1,this.editingId=null,this.errorMessage="",this.showForm=!1}toggleForm(){this.showForm=!this.showForm,this.showForm||this.resetForm()}toggleExpand(e){this.expandedOrderId=this.expandedOrderId===e?null:e}getProductName(e){let n=this.productList.find(r=>r.id===e);return n?n.name:"Produit_Inconnu"}getDescription(e){return this.productList.find(r=>r.id===e)?.description||"Pas_de_description"}getSubtotal(e){let n=e&&typeof e.quantity=="number"?e.quantity:0,r=e&&typeof e.unitPrice=="number"?e.unitPrice:0;return n*r}formatDate(e){if(!e)return"-";let n;return e instanceof C?n=e.toDate():n=new Date(e),isNaN(n.getTime())?"-":n.toLocaleDateString("fr-FR")}getStatusLabel(e){let n=e||"pending";return{pending:"En Attente",confirmed:"Confirm\xE9e",delivered:"Livr\xE9e",cancelled:"Annul\xE9e"}[n]||n}getStatusClass(e){return{pending:"bg-yellow-100 text-yellow-800",confirmed:"bg-blue-100 text-blue-800",delivered:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800"}[e||"pending"]||"bg-gray-100 text-gray-800"}printList(){this.filteredOrders$.pipe(q(1)).subscribe(e=>{if(!e||e.length===0){alert("Aucune commande \xE0 imprimer.");return}this.generatePrintHTML(e)})}generatePrintHTML(e){let n=window.open("","_blank","width=900,height=700");if(!n){alert("\u274C Popup bloqu\xE9e !");return}let r=new Date().toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),l=e.length,p=e.reduce((c,b)=>c+(b.totalAmount||0),0),v=e.reduce((c,b)=>c+b.products.length,0),x={pending:e.filter(c=>(c.status||"pending")==="pending").length,confirmed:e.filter(c=>c.status==="confirmed").length,delivered:e.filter(c=>c.status==="delivered").length,cancelled:e.filter(c=>c.status==="cancelled").length},_=[];this.searchTerm&&_.push(`Recherche: "${this.searchTerm}"`),this.selectedSupplier&&_.push(`Fournisseur: ${this.selectedSupplier}`),this.dateFrom&&_.push(`Date D\xE9but: ${new Date(this.dateFrom).toLocaleDateString("fr-FR")}`),this.dateTo&&_.push(`Date Fin: ${new Date(this.dateTo).toLocaleDateString("fr-FR")}`),this.minAmount!==null&&_.push(`Montant Min: ${this.minAmount} DT`),this.maxAmount!==null&&_.push(`Montant Max: ${this.maxAmount} DT`),this.statusFilter!=="all"&&_.push(`Statut: ${this.getStatusLabel(this.statusFilter)}`);let P={date:"Date",supplier:"Fournisseur",amount:"Montant"};_.push(`Tri: ${P[this.sortBy]} (${this.sortOrder==="asc"?"\u2191":"\u2193"})`);let B=e.map((c,b)=>`
      <tr>
        <td>${b+1}</td>
        <td>${c.orderNumber}</td>
        <td>${this.formatDate(c.date)}</td>
        <td>${c.supplier}</td>
        <td>${c.products.length}</td>
        <td><span class="badge badge-${c.status||"pending"}">${this.getStatusLabel(c.status)}</span></td>
        <td>${(c.totalAmount||0).toFixed(2)} DT</td>
      </tr>
    `).join(""),f=`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Liste Bons de Commande - ${r}</title>
        <style>
          @page { margin: 15mm; size: A4 landscape; }
          body { font-family: Arial, sans-serif; margin: 0; padding: 15px; font-size: 10pt; }
          .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #f59e0b; padding-bottom: 10px; }
          .header h1 { font-size: 20pt; color: #f59e0b; margin: 0 0 5px 0; }
          .filters { background: #fef3c7; padding: 8px; margin-bottom: 12px; border-left: 3px solid #f59e0b; }
          .filters h3 { font-size: 11pt; margin: 0 0 5px 0; }
          .filters ul { list-style: none; padding: 0; margin: 0; }
          .filters li { font-size: 9pt; margin: 2px 0; }
          .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
          .stat { background: #f9fafb; border: 1px solid #e5e7eb; padding: 8px; text-align: center; }
          .stat .label { font-size: 8pt; color: #666; }
          .stat .value { font-size: 14pt; font-weight: bold; color: #f59e0b; }
          table { width: 100%; border-collapse: collapse; }
          thead { background: #f59e0b; color: white; }
          th, td { padding: 6px 8px; text-align: left; border: 1px solid #ddd; font-size: 9pt; }
          tbody tr:nth-child(even) { background: #f9fafb; }
          tfoot { background: #fef3c7; font-weight: bold; }
          /* Badge styles for print */
          .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 8pt; font-weight: bold; border: 1px solid #ccc; background: #fff; color: #000;}
          .badge-pending { border-color: #f59e0b; }
          .badge-confirmed { border-color: #3b82f6; }
          .badge-delivered { border-color: #16a34a; }
          .badge-cancelled { border-color: #dc2626; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>\u{1F4CB} Bons de Commande - Liste</h1>
          <p>Date d'impression : ${r}</p>
        </div>
        <div class="filters">
          <h3>Filtres Appliqu\xE9s</h3>
          <ul>${_.map(c=>`<li>\u2022 ${c}</li>`).join("")}</ul>
        </div>
        <div class="stats">
          <div class="stat"><div class="label">Total Commandes</div><div class="value">${l}</div></div>
          <div class="stat"><div class="label">Total Produits</div><div class="value">${v}</div></div>
          <div class="stat"><div class="label">Montant Total</div><div class="value">${p.toFixed(2)} DT</div></div>
          <div class="stat"><div class="label">En Attente</div><div class="value">${x.pending}</div></div>
        </div>
        <table>
          <thead>
            <tr><th>#</th><th>N\xB0 Commande</th><th>Date</th><th>Fournisseur</th><th>Produits</th><th>Statut</th><th>Montant</th></tr>
          </thead>
          <tbody>${B}</tbody>
          <tfoot>
            <tr><td colspan="4">TOTAL (${l} commandes)</td><td>${v}</td><td>-</td><td>${p.toFixed(2)} DT</td></tr>
          </tfoot>
        </table>
      </body>
      </html>
    `;n.document.write(f),n.document.close(),n.focus(),setTimeout(()=>n.print(),500)}printItem(e){this.filteredOrders$.pipe(q(1)).subscribe(n=>{let r=n.find(x=>x.id===e.id);if(!r){console.error("Bon de commande non trouv\xE9 pour impression:",e.id),alert("Erreur : Bon de commande non trouv\xE9.");return}let l=window.open("","_blank","width=800,height=600");if(!l){alert("\u274C Popup bloqu\xE9e ! Veuillez autoriser les popups pour ce site.");return}let p=r.products.map(x=>`
        <tr>
          <td>${x.productName||"N/A"}</td>
          <td class="description">${this.getDescription(x.productId)}</td>
          <td>${x.quantity||0}</td>
          <td>${(x.unitPrice||0).toFixed(2)} DT</td>
          <td>${(x.subtotal||0).toFixed(2)} DT</td>
        </tr>
      `).join(""),v=`<!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Bon de Commande ${r.orderNumber}</title>
          <style>
            /* Basic print styles - adapt colors if needed */
            body { font-family: Arial, sans-serif; padding: 20px; font-size: 10pt; }
            h1 { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
            .details-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
            .details-table th, .details-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
            .details-table th { background: #f3f4f6; width: 30%; }
            .products-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            .products-table th, .products-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
            .products-table th { background: #f3f4f6; }
            .products-table tfoot th, .products-table tfoot td { font-weight: bold; background: #fef3c7; } /* Light amber footer */
            .description { font-size: 9pt; color: #555; font-style: italic; max-width: 200px; word-wrap: break-word; }
            .total-amount { color: #d97706; } /* Amber total */
             /* Status badge styles for print */
            .badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 8pt; font-weight: bold; border: 1px solid #ccc; background: #fff; color: #000;}
            .badge-pending { border-color: #f59e0b; }
            .badge-confirmed { border-color: #3b82f6; }
            .badge-delivered { border-color: #16a34a; }
            .badge-cancelled { border-color: #dc2626; }
          </style>
        </head>
        <body>
          <h1>Bon de Commande N\xB0 ${r.orderNumber}</h1>
          <table class="details-table">
            <tr><th>Date</th><td>${this.formatDate(r.date)}</td></tr>
            <tr><th>Fournisseur</th><td>${r.supplier}</td></tr>
            ${r.expectedDeliveryDate?`<tr><th>Livraison Pr\xE9vue</th><td>${this.formatDate(r.expectedDeliveryDate)}</td></tr>`:""}
            <tr><th>Statut</th><td><span class="badge badge-${r.status||"pending"}">${this.getStatusLabel(r.status)}</span></td></tr>
            ${r.notes?`<tr><th>Notes</th><td>${r.notes}</td></tr>`:""}
          </table>

          <h3>Produits</h3>
          <table class="products-table">
            <thead>
              <tr>
                <th>Produit</th>
                <th>Description</th>
                <th>Quantit\xE9</th>
                <th>Prix Unit.</th>
                <th>Sous-total</th>
              </tr>
            </thead>
            <tbody>
              ${p}
            </tbody>
            <tfoot>
              <tr>
                <th colspan="4" style="text-align: right;">Total</th>
                <td class.total-amount">${(r.totalAmount||0).toFixed(2)} DT</td>
              </tr>
            </tfoot>
          </table>
        </body>
        </html>
      `;l.document.write(v),l.document.close(),setTimeout(()=>{l.focus(),l.print()},250)})}};u.\u0275fac=function(n){return new(n||u)(I(Me),I(Te),I($e),I(xe),I(ne))},u.\u0275cmp=J({type:u,selectors:[["app-purchase-order"]],decls:71,vars:21,consts:[[1,"container","mx-auto","px-4","py-8"],[1,"text-3xl","font-bold","text-gray-800","mb-6"],["class","bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4",4,"ngIf"],[1,"flex","flex-col","md:flex-row","justify-between","items-center","mb-4","gap-4"],["type","text","placeholder","\u{1F50D} Rechercher par num\xE9ro...",1,"w-full","md:w-1/3","px-4","py-2","border","rounded-lg",3,"ngModelChange","ngModel"],[1,"flex","gap-2"],[1,"bg-purple-600","hover:bg-purple-700","text-white","font-bold","py-2","px-6","rounded-lg","flex","items-center","space-x-2","no-print",3,"click"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"],[1,"bg-green-600","hover:bg-green-700","text-white","font-bold","py-2","px-6","rounded-lg","no-print",3,"click"],[4,"ngIf"],[1,"bg-white","shadow-md","rounded-lg","p-4","mb-6","no-print"],[1,"text-lg","font-semibold","mb-3","flex","items-center"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-5","h-5","mr-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"],[1,"grid","grid-cols-1","md:grid-cols-4","gap-4"],[1,"block","text-sm","font-medium","text-gray-700","mb-1"],["bindLabel","name","bindValue","name","placeholder","Tous",1,"w-full",3,"ngModelChange","ngModel","items","clearable"],[1,"w-full","px-3","py-2","border","rounded-lg",3,"ngModelChange","ngModel"],["value","all"],["value","pending"],["value","confirmed"],["value","delivered"],["value","cancelled"],["type","date",1,"w-full","px-3","py-2","border","rounded-lg",3,"ngModelChange","ngModel"],["value","date"],["value","supplier"],["value","amount"],["type","number","placeholder","0",1,"w-full","px-3","py-2","border","rounded-lg",3,"ngModelChange","ngModel"],["type","number","placeholder","10000",1,"w-full","px-3","py-2","border","rounded-lg",3,"ngModelChange","ngModel"],[1,"mt-4"],[1,"bg-gray-500","hover:bg-gray-600","text-white","px-4","py-2","rounded-lg",3,"click"],["class","bg-white shadow-md rounded-lg p-6 mb-6 no-print",4,"ngIf"],["class","space-y-4",4,"ngIf"],[1,"bg-red-100","border","border-red-400","text-red-700","px-4","py-3","rounded","mb-4"],[1,"float-right",3,"click"],[1,"bg-white","shadow-md","rounded-lg","p-6","mb-6","no-print"],[1,"text-2xl","font-semibold","mb-4"],[1,"space-y-4",3,"ngSubmit","formGroup"],[1,"block","text-gray-700","font-medium","mb-2"],["formControlName","orderNumber","type","text","readonly","",1,"w-full","px-4","py-2","border","rounded-lg","bg-gray-100"],["formControlName","date","type","date",1,"w-full","px-4","py-2","border","rounded-lg"],["formControlName","supplier","bindLabel","name","bindValue","name","placeholder","-- S\xE9lectionnez --",1,"w-full",3,"items","searchable","clearable"],["formControlName","expectedDeliveryDate","type","date",1,"w-full","px-4","py-2","border","rounded-lg"],[1,"border-t","pt-4"],[1,"text-lg","font-semibold","mb-3"],["formArrayName","products",1,"space-y-3"],["class","grid grid-cols-1 md:grid-cols-12 gap-3 items-end bg-gray-50 p-3 rounded",3,"formGroupName",4,"ngFor","ngForOf"],[1,"mt-4","bg-amber-50","p-4","rounded"],[1,"flex","justify-between","text-xl","font-bold"],[1,"text-amber-600"],["formControlName","status",1,"w-full","px-4","py-2","border","rounded-lg"],["formControlName","notes","rows","2",1,"w-full","px-4","py-2","border","rounded-lg"],[1,"flex","gap-4"],["type","submit",1,"bg-amber-600","hover:bg-amber-700","text-white","font-bold","py-2","px-6","rounded-lg","disabled:bg-gray-400",3,"disabled"],["type","button",1,"bg-gray-500","hover:bg-gray-600","text-white","font-bold","py-2","px-6","rounded-lg",3,"click"],[1,"grid","grid-cols-1","md:grid-cols-12","gap-3","items-end","bg-gray-50","p-3","rounded",3,"formGroupName"],[1,"md:col-span-4"],[1,"block","text-sm","text-gray-600","mb-1"],["formControlName","productId",1,"w-full","px-3","py-2","border","rounded",3,"change"],["value",""],[3,"value",4,"ngFor","ngForOf"],[1,"md:col-span-2"],["formControlName","quantity","type","number",1,"w-full","px-3","py-2","border","rounded"],["formControlName","unitPrice","type","number","step","0.01",1,"w-full","px-3","py-2","border","rounded"],["readonly","",1,"w-full","px-3","py-2","border","rounded","bg-gray-100",3,"value"],[1,"md:col-span-2","flex","gap-2"],["type","button",1,"bg-blue-500","text-white","px-3","py-2","rounded",3,"click"],["type","button",1,"bg-red-500","text-white","px-3","py-2","rounded","disabled:bg-gray-300",3,"click","disabled"],[3,"value"],[1,"space-y-4"],["class","bg-white shadow rounded-lg overflow-hidden voucher-card",4,"ngFor","ngForOf"],["class","text-center py-8 text-gray-500",4,"ngIf"],[1,"bg-white","shadow","rounded-lg","overflow-hidden","voucher-card"],[1,"px-6","py-4","flex","justify-between","items-center","cursor-pointer","hover:bg-gray-50",3,"click"],[1,"flex-1","grid","grid-cols-5","gap-4"],[1,"px-2","py-1","rounded","text-xs",3,"ngClass"],[1,"text-amber-600","no-print"],["class","px-6 py-4 bg-gray-50 border-t",4,"ngIf"],[1,"px-6","py-4","bg-gray-50","border-t"],[1,"min-w-full"],[1,"bg-gray-100"],[1,"px-4","py-2","text-left","text-sm"],["class","border-t",4,"ngFor","ngForOf"],[1,"bg-amber-50","font-bold"],["colspan","4",1,"px-4","py-2","text-right"],[1,"px-4","py-2","text-amber-600"],[1,"mt-4","flex","gap-2","no-print"],[1,"bg-indigo-600","hover:bg-indigo-700","text-white","px-4","py-2","rounded",3,"click"],[1,"bg-red-600","hover:bg-red-700","text-white","px-4","py-2","rounded",3,"click"],[1,"bg-purple-600","hover:bg-purple-700","text-white","px-4","py-2","rounded",3,"click"],[1,"border-t"],[1,"px-4","py-2"],[1,"px-4","py-2","text-xs","text-gray-600"],[1,"px-4","py-2","font-semibold"],[1,"text-center","py-8","text-gray-500"]],template:function(n,r){n&1&&(i(0,"div",0)(1,"h1",1),o(2,"Bons de Commande"),t(),F(3,Ve,6,1,"div",2),i(4,"div",3)(5,"input",4),h("ngModelChange",function(p){return r.onSearchChange(p)}),t(),i(6,"div",5)(7,"button",6),h("click",function(){return r.printList()}),j(),i(8,"svg",7),T(9,"path",8),t(),z(),i(10,"span"),o(11,"Imprimer Liste"),t()(),i(12,"button",9),h("click",function(){return r.toggleForm()}),F(13,Be,2,0,"span",10)(14,qe,2,0,"span",10),t()()(),i(15,"div",11)(16,"h3",12),j(),i(17,"svg",13),T(18,"path",14),t(),o(19," Filtres Avanc\xE9s "),t(),z(),i(20,"div",15)(21,"div")(22,"label",16),o(23,"Fournisseur"),t(),i(24,"ng-select",17),w(25,"async"),h("ngModelChange",function(p){return r.onSupplierFilterChange(p)}),t()(),i(26,"div")(27,"label",16),o(28,"Statut"),t(),i(29,"select",18),h("ngModelChange",function(p){return r.onStatusFilterChange(p)}),i(30,"option",19),o(31,"Tous"),t(),i(32,"option",20),o(33,"En Attente"),t(),i(34,"option",21),o(35,"Confirm\xE9e"),t(),i(36,"option",22),o(37,"Livr\xE9e"),t(),i(38,"option",23),o(39,"Annul\xE9e"),t()()(),i(40,"div")(41,"label",16),o(42,"Date D\xE9but"),t(),i(43,"input",24),h("ngModelChange",function(p){return r.onDateFromChange(p)}),t()(),i(44,"div")(45,"label",16),o(46,"Date Fin"),t(),i(47,"input",24),h("ngModelChange",function(p){return r.onDateToChange(p)}),t()(),i(48,"div")(49,"label",16),o(50,"Trier par"),t(),i(51,"select",18),h("ngModelChange",function(p){return r.onSortChange(p)}),i(52,"option",25),o(53),t(),i(54,"option",26),o(55),t(),i(56,"option",27),o(57),t()()(),i(58,"div")(59,"label",16),o(60,"Montant Min (DT)"),t(),i(61,"input",28),h("ngModelChange",function(p){return r.onMinAmountChange(p)}),t()(),i(62,"div")(63,"label",16),o(64,"Montant Max (DT)"),t(),i(65,"input",29),h("ngModelChange",function(p){return r.onMaxAmountChange(p)}),t()()(),i(66,"div",30)(67,"button",31),h("click",function(){return r.clearFilters()}),o(68," R\xE9initialiser Filtres "),t()()(),F(69,He,56,16,"div",32)(70,Je,5,6,"div",33),t()),n&2&&(d(3),m("ngIf",r.errorMessage),d(2),m("ngModel",r.searchTerm),d(8),m("ngIf",!r.showForm),d(),m("ngIf",r.showForm),d(10),m("ngModel",r.selectedSupplier)("items",N(25,18,r.suppliers$)??R(20,Ae))("clearable",!0),d(5),m("ngModel",r.statusFilter),d(14),m("ngModel",r.dateFrom),d(4),m("ngModel",r.dateTo),d(4),m("ngModel",r.sortBy),d(2),y("Date ",r.sortBy==="date"?r.sortOrder==="asc"?"\u2191":"\u2193":""),d(2),y("Fournisseur ",r.sortBy==="supplier"?r.sortOrder==="asc"?"\u2191":"\u2193":""),d(2),y("Montant ",r.sortBy==="amount"?r.sortOrder==="asc"?"\u2191":"\u2193":""),d(4),m("ngModel",r.minAmount),d(4),m("ngModel",r.maxAmount),d(4),m("ngIf",r.showForm),d(),m("ngIf",!r.isLoading))},dependencies:[_e,se,fe,be,oe,ce,ge,ae,de,pe,he,ue,me,Pe,Oe,re,X,Z,ee,ve,le,te,ie],styles:[".container[_ngcontent-%COMP%]{max-width:1280px}button[_ngcontent-%COMP%]{transition:all .2s}@media (max-width: 768px){table[_ngcontent-%COMP%]{display:block;overflow-x:auto}}"]});let s=u;return s})();export{mt as PurchaseOrderComponent};
